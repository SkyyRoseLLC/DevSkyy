# GitHub PR Auto-Fix Feature

## Overview

The DevSkyy Enhanced Platform now includes an automated pull request fixing feature that automatically detects and fixes code issues when pull requests target the main branch.

## How It Works

### Webhook Endpoint: `/github/pr-webhook`

This endpoint listens for GitHub webhook events and automatically processes pull requests targeting the main branch.

### Trigger Conditions

The auto-fix feature triggers when:
- A pull request event is received via webhook
- The PR targets the `main` branch
- The action is either `opened` (new PR) or `synchronize` (new commits pushed)

### Auto-Fix Workflow

When triggered, the system:

1. **Scans the codebase** using `scan_site()` function
2. **Identifies and fixes issues** using `fix_code()` function
3. **Commits fixes** with PR-specific commit messages
4. **Returns detailed results** about the fixes applied

## Webhook Payload Example

Send a POST request to `/github/pr-webhook` with a GitHub webhook payload:

```json
{
  "action": "opened",
  "pull_request": {
    "number": 123,
    "base": {
      "ref": "main"
    },
    "head": {
      "ref": "feature-branch"
    }
  }
}
```

## Response Format

### Successful Processing

```json
{
  "status": "success",
  "action": "opened",
  "pr_number": 123,
  "base_branch": "main",
  "fix_result": {
    "status": "fixes_applied",
    "pr_number": 123,
    "head_branch": "feature-branch",
    "fixes_count": 5,
    "commit_result": {
      "status": "success",
      "commit_hash": "abc123"
    }
  },
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

### No Fixes Needed

```json
{
  "status": "success",
  "action": "opened", 
  "pr_number": 123,
  "base_branch": "main",
  "fix_result": {
    "status": "no_fixes_needed",
    "pr_number": 123,
    "head_branch": "feature-branch",
    "message": "No issues found to fix"
  },
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

### Ignored Events

```json
{
  "status": "ignored",
  "reason": "PR targets 'develop', not 'main'"
}
```

## Commit Message Format

Auto-fixes generate commit messages with PR context:

```
Auto-fix: PR #123 - 5 issues resolved
Branch: feature-branch

Summary:
- Fixed 3 error(s)
- Resolved 2 warning(s)

Details:
- main.py: Fixed syntax error
- config.py: Resolved undefined variable
- utils.py: Applied code optimization

Auto-generated by DevSkyy Enhanced Platform (PR Auto-Fix)
```

## GitHub Webhook Setup

To enable this feature in your GitHub repository:

1. Go to Repository Settings â†’ Webhooks
2. Add new webhook with URL: `https://your-domain.com/github/pr-webhook`
3. Select "Pull requests" events
4. Set Content-Type to `application/json`
5. Add webhook secret (optional but recommended)

## Ignored Events

The webhook ignores:
- PRs not targeting the `main` branch
- Actions other than `opened` and `synchronize`
- Non-pull request events (pushes, issues, etc.)

## Error Handling

The endpoint includes comprehensive error handling:
- Invalid JSON payloads return 422 status
- Processing errors return 500 status with error details
- All errors are logged for debugging

## Integration with Existing Workflow

This feature complements the existing `/run` endpoint which manually triggers:
- `scan_site()` - Code scanning
- `fix_code()` - Issue fixing  
- `commit_fixes()` - Git operations
- `schedule_hourly_job()` - Scheduling

The auto-fix feature uses the same underlying functions but adds webhook automation for PR events.