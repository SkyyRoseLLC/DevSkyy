name: 🚀 Stable CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: '50'

jobs:
  # ============================================================================
  # BASIC VALIDATION
  # ============================================================================
  
  validation:
    name: 🔍 Basic Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 📦 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: 🔍 Python Syntax Check
        run: |
          python -m py_compile main.py
          echo "✅ Main application syntax OK"
      
      - name: 🧪 Import Test
        run: |
          python -c "import main; print('✅ Main application imports successfully')"
      
      - name: 📋 Test Discovery
        run: |
          python -m pytest --collect-only -q | head -10
          echo "✅ Test discovery successful"

  # ============================================================================
  # CORE TESTS
  # ============================================================================
  
  core-tests:
    name: 🧪 Core Tests
    runs-on: ubuntu-latest
    needs: validation
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 📦 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock
      
      - name: 🧪 Run Core Tests
        run: |
          pytest tests/test_main.py tests/test_basic_functionality.py -v \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=30 \
            --tb=short \
            --maxfail=10
      
      - name: 📊 Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: core
          name: core-coverage

  # ============================================================================
  # API TESTS
  # ============================================================================
  
  api-tests:
    name: 🌐 API Tests
    runs-on: ubuntu-latest
    needs: validation
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 📦 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock
      
      - name: 🧪 Run API Tests
        run: |
          pytest tests/api/ -v \
            --cov=api \
            --cov-report=term-missing \
            --cov-report=xml:coverage-api.xml \
            --cov-fail-under=30 \
            --tb=short \
            --maxfail=5
      
      - name: 📊 Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage-api.xml
          flags: api
          name: api-coverage

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================
  
  integration-tests:
    name: 🔗 Integration Tests
    runs-on: ubuntu-latest
    needs: [core-tests, api-tests]
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 📦 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock
      
      - name: 🧪 Run Integration Tests
        run: |
          pytest tests/integration/ tests/security/ -v \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml:coverage-integration.xml \
            --cov-fail-under=20 \
            --tb=short \
            --maxfail=5
      
      - name: 📊 Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage-integration.xml
          flags: integration
          name: integration-coverage

  # ============================================================================
  # DEPLOYMENT READINESS
  # ============================================================================
  
  deployment-check:
    name: 🚀 Deployment Readiness
    runs-on: ubuntu-latest
    needs: [core-tests, api-tests, integration-tests]
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 📦 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: 🏗️ Build Check
        run: |
          python -c "
          import main
          app = main.app
          print(f'✅ App Title: {app.title}')
          print(f'✅ App Version: {app.version}')
          print('✅ Application builds successfully')
          "
      
      - name: 🎯 Final Status
        run: |
          echo "🎉 ALL CHECKS PASSED - READY FOR DEPLOYMENT!"
          echo "✅ Syntax validation: PASSED"
          echo "✅ Import tests: PASSED"
          echo "✅ Core tests: PASSED"
          echo "✅ API tests: PASSED"
          echo "✅ Integration tests: PASSED"
          echo "✅ Build check: PASSED"
          echo ""
          echo "🚀 DevSkyy Platform is production-ready!"
